<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOYOSOYO SACCO Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        
        .chat-widget {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
        }
        
        .chat-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7dd3c0 0%, #1e7b85 100%);
            border: 3px solid white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
            transition: all 0.3s ease;
        }
        
        .chat-button:hover {
            background: #16a34a;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            transform: scale(1.05);
        }
        
        .chat-window {
            width: 400px;
            height: 550px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            border: 1px solid rgba(125, 211, 192, 0.3);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #7dd3c0 0%, #1e7b85 100%);
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .chat-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            height: 400px;
        }
        
        .message {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .message.user {
            flex-direction: row-reverse;
            justify-content: flex-start;
        }
        
        .message-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        .message-bubble {
            max-width: 75%;
            padding: 12px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .message.assistant .message-avatar {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }
        
        .message.assistant .message-bubble {
            background: #f3f4f6;
            color: #374151;
            margin-right: 8px;
        }
        
        .message.user .message-avatar {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }
        
        .message.user .message-bubble {
            background: #3b82f6;
            color: white;
            margin-left: 8px;
        }
        
        .chat-input {
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }
        
        .chat-input input:focus {
            border-color: #22c55e;
        }
        
        .send-button {
            padding: 8px 12px;
            background: #22c55e;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .send-button:hover {
            background: #16a34a;
        }
        
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .close-button {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .close-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite both;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.1s; }
        .typing-dot:nth-child(3) { animation-delay: 0.2s; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes bounce {
            0%, 80%, 100% { 
                transform: scale(0);
                opacity: 0.5;
            } 
            40% { 
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="chat-widget" id="chatWidget">
        <button class="chat-button" id="chatButton">
            <svg width="50" height="50" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="100" cy="100" r="95" fill="white"/>
                <circle cx="100" cy="100" r="75" fill="#1e7b85"/>
                <path d="M100 40 L100 40 C120 45, 130 55, 130 75 L130 125 C130 145, 120 155, 100 160 C80 155, 70 145, 70 125 L70 75 C70 55, 80 45, 100 40 Z" fill="white"/>
                <path d="M100 50 L100 50 C115 54, 122 62, 122 78 L122 120 C122 136, 115 144, 100 148 C85 144, 78 136, 78 120 L78 78 C78 62, 85 54, 100 50 Z" fill="none" stroke="#7dd3c0" stroke-width="2"/>
                <text x="100" y="85" text-anchor="middle" fill="#1e7b85" font-size="16" font-weight="bold" font-family="Arial, sans-serif">SACCO</text>
                <g transform="translate(130, 70)">
                    <circle cx="0" cy="0" r="12" fill="#1e7b85"/>
                    <path d="M-6 -2 L6 -2 L6 2 L-6 2 Z" fill="white"/>
                    <path d="M-2 -6 L2 -6 L2 6 L-2 6 Z" fill="white"/>
                </g>
            </svg>
        </button>
        
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <div class="chat-header-info">
                    <div class="chat-avatar">
                        <svg width="32" height="32" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="100" cy="100" r="95" fill="#7dd3c0"/>
                            <circle cx="100" cy="100" r="75" fill="#1e7b85"/>
                            <path d="M100 40 L100 40 C120 45, 130 55, 130 75 L130 125 C130 145, 120 155, 100 160 C80 155, 70 145, 70 125 L70 75 C70 55, 80 45, 100 40 Z" fill="white"/>
                            <text x="100" y="85" text-anchor="middle" fill="#1e7b85" font-size="16" font-weight="bold" font-family="Arial, sans-serif">SACCO</text>
                            <g transform="translate(130, 70)">
                                <circle cx="0" cy="0" r="12" fill="#1e7b85"/>
                                <path d="M-6 -2 L6 -2 L6 2 L-6 2 Z" fill="white"/>
                                <path d="M-2 -6 L2 -6 L2 6 L-2 6 Z" fill="white"/>
                            </g>
                        </svg>
                    </div>
                    <div>
                        <h3 style="font-weight: 600; font-size: 14px; margin: 0;">SOYOSOYO SACCO</h3>
                        <p style="font-size: 12px; opacity: 0.9; margin: 0;">Assistant</p>
                    </div>
                </div>
                <button class="close-button" id="closeButton">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z"/>
                    </svg>
                </button>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <div class="message-avatar">
                        <svg width="16" height="16" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect width="32" height="32" rx="16" fill="#22c55e"/>
                            <path d="M8 12h16v8H8z" fill="white" fill-opacity="0.9"/>
                            <circle cx="12" cy="16" r="2" fill="#22c55e"/>
                            <circle cx="20" cy="16" r="2" fill="#22c55e"/>
                            <path d="M10 20h12v2H10z" fill="white" fill-opacity="0.8"/>
                            <text x="16" y="11" text-anchor="middle" fill="white" font-size="8" font-weight="bold">SACCO</text>
                        </svg>
                    </div>
                    <div class="message-bubble">
                        Hello! I'm the SOYOSOYO SACCO Assistant. I can help you with information about our services, loans, savings products, and membership requirements. How can I assist you today?
                    </div>
                </div>
            </div>
            
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Ask about loans, savings, membership...">
                <button class="send-button" id="sendButton">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        class SoyoSaccoChatWidget {
            constructor() {
                this.isOpen = false;
                this.conversationId = null;
                this.isLoading = false;
                this.apiBaseUrl = window.location.origin; // Change this to your API URL if different
                
                this.chatButton = document.getElementById('chatButton');
                this.chatWindow = document.getElementById('chatWindow');
                this.closeButton = document.getElementById('closeButton');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.chatMessages = document.getElementById('chatMessages');
                
                this.bindEvents();
            }
            
            bindEvents() {
                this.chatButton.addEventListener('click', () => this.openChat());
                this.closeButton.addEventListener('click', () => this.closeChat());
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });
            }
            
            openChat() {
                this.isOpen = true;
                this.chatButton.style.display = 'none';
                this.chatWindow.style.display = 'flex';
            }
            
            closeChat() {
                this.isOpen = false;
                this.chatButton.style.display = 'flex';
                this.chatWindow.style.display = 'none';
            }
            
            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message || this.isLoading) return;
                
                this.isLoading = true;
                this.messageInput.value = '';
                this.sendButton.disabled = true;
                
                // Add user message to chat
                this.addMessage(message, 'user');
                
                // Show typing indicator
                this.showTypingIndicator();
                
                try {
                    const response = await fetch(`${this.apiBaseUrl}/api/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message,
                            conversationId: this.conversationId,
                            includeContext: true
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to send message');
                    }
                    
                    const data = await response.json();
                    this.conversationId = data.conversationId;
                    
                    // Remove typing indicator and add assistant response
                    this.hideTypingIndicator();
                    this.addMessage(data.response, 'assistant');
                    
                } catch (error) {
                    console.error('Chat error:', error);
                    this.hideTypingIndicator();
                    this.addMessage("I'm sorry, I'm having trouble connecting right now. Please try again or visit soyosoyosacco.com for assistance.", 'assistant');
                } finally {
                    this.isLoading = false;
                    this.sendButton.disabled = false;
                }
            }
            
            addMessage(content, role) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'message-avatar';
                
                if (role === 'assistant') {
                    avatarDiv.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect width="32" height="32" rx="16" fill="#22c55e"/>
                            <path d="M8 12h16v8H8z" fill="white" fill-opacity="0.9"/>
                            <circle cx="12" cy="16" r="2" fill="#22c55e"/>
                            <circle cx="20" cy="16" r="2" fill="#22c55e"/>
                            <path d="M10 20h12v2H10z" fill="white" fill-opacity="0.8"/>
                            <text x="16" y="11" text-anchor="middle" fill="white" font-size="8" font-weight="bold">SACCO</text>
                        </svg>
                    `;
                } else {
                    avatarDiv.textContent = 'U';
                }
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'message-bubble';
                bubbleDiv.textContent = content;
                
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(bubbleDiv);
                
                this.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
            }
            
            showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typingIndicator';
                typingDiv.className = 'message assistant';
                typingDiv.innerHTML = `
                    <div class="message-avatar">
                        <svg width="16" height="16" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect width="32" height="32" rx="16" fill="#22c55e"/>
                            <path d="M8 12h16v8H8z" fill="white" fill-opacity="0.9"/>
                            <circle cx="12" cy="16" r="2" fill="#22c55e"/>
                            <circle cx="20" cy="16" r="2" fill="#22c55e"/>
                            <path d="M10 20h12v2H10z" fill="white" fill-opacity="0.8"/>
                            <text x="16" y="11" text-anchor="middle" fill="white" font-size="8" font-weight="bold">SACCO</text>
                        </svg>
                    </div>
                    <div class="message-bubble">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                `;
                this.chatMessages.appendChild(typingDiv);
                this.scrollToBottom();
            }
            
            hideTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
            
            scrollToBottom() {
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }
        }
        
        // Initialize the chat widget when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new SoyoSaccoChatWidget();
        });
    </script>
</body>
</html>